<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отдел контента</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 12c.552 0 1.005-.449.95-.998a10 10 0 0 0-8.953-8.951c-.55-.055-.998.398-.998.95v8a1 1 0 0 0 1 1z'/%3E%3Cpath d='M21.21 15.89A10 10 0 1 1 8 2.83'/%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --color-primary: #ff8c00;
            --color-success: #28a745;
            --color-danger: #dc2626;
            --color-bg-primary: #fff;
            --color-bg-secondary: #f5f7fa;
            --color-bg-tertiary: #f8f9fa;
            --color-bg-modal-overlay: rgba(0, 0, 0, 0.5);
            --color-secondary: #555;
            --color-tertiary: #666;
            --color-white: #fff;
            --color-dark: #1e293b;
            --color-border-dashed: #ccc;
            --color-border-primary: #0369a1;
            --color-status-completed-bg: #d4edda;
            --color-neutral-dark: #999;
            --color-neutral-light: rgba(255, 255, 255, 0.2);
            --font-family-primary: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-size-base: 16px;
            --font-size-sm: 14px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            --font-size-2xl: 28px;
            --font-size-3xl: 36px;
            --font-size-4xl: 44px;
            --font-weight-normal: 400;
            --font-weight-semibold: 600;
            --radius-base: 4px;
            --radius-md: 8px;
            --radius-2xl: 14px;
            --radius-circle: 50%;
            --spacing-xs: 5px;
            --spacing-sm: 10px;
            --spacing-md: 15px;
            --spacing-lg: 20px;
            --spacing-xl: 25px;
            --spacing-2xl: 30px;
            --spacing-3xl: 40px;
            --spacing-4xl: 60px;
            --chart-height: 400px;
            --timeline-step-marker-size: 36px;
            --step-number-size: 28px;
            --modal-close-btn-size: 40px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            scroll-behavior: smooth;
        }

        body {
            height: 100%;
            background: var(--color-bg-secondary);
            min-width: 1440px;
            position: relative;
            font-family: var(--font-family-primary);
            font-size: var(--font-size-base);
            line-height: 1.5;
        }

        h1 {
            font-size: var(--font-size-4xl);
            margin-bottom: var(--spacing-sm);
        }

        h2 {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--spacing-lg);
        }

        h3 {
            font-size: var(--font-size-xl);
            margin-bottom: var(--spacing-md);
        }

        h4 {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-sm);
        }

        article {
            padding: var(--spacing-4xl) var(--spacing-lg) var(--spacing-lg);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            margin: 0 auto;
            height: 100%;
            max-width: 1400px;
        }

        header,
        footer,
        section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-lg);
            padding: var(--spacing-lg);
        }

        main {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            flex-grow: 1;
            background-color: var(--color-bg-primary);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-2xl) var(--spacing-lg);
            gap: var(--spacing-lg);
        }

        button {
            border: 1px solid var(--color-dark);
            display: flex;
            align-items: center;
            background: var(--color-bg-primary);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: var(--font-size-base);
            gap: var(--spacing-sm);
            transition: all 0.3s ease;
        }

        button:hover {
            background: var(--color-dark);
            color: var(--color-white);
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        a:hover {
            text-decoration: none;
        }

        .accent {
            color: var(--color-danger);
            font-weight: var(--font-weight-semibold);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th {
            background: var(--color-bg-tertiary);
            padding: var(--spacing-md);
            font-weight: normal;
            border-bottom: 1px dashed var(--color-border-dashed);
            text-align: left;
        }

        table td {
            padding: var(--spacing-md);
        }

        table tr {
            border-bottom: 1px dashed var(--color-border-dashed);
        }

        table tr:last-child {
            border-bottom: none;
        }

        table tr:nth-child(even) {
            background-color: var(--color-bg-tertiary);
        }

        ul {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            padding-left: var(--spacing-xl);
        }

        ul li {
            margin-bottom: var(--spacing-xs);
        }

        .wrapper {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .menu {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            flex-shrink: 0;
        }

        .main-loading {
            color: var(--color-tertiary);
            padding: var(--spacing-3xl);
            text-align: center;
            font-size: var(--font-size-lg);
        }

        .main-error {
            color: var(--color-danger);
            padding: var(--spacing-lg);
            text-align: center;
            font-size: var(--font-size-lg);
        }

        .main-warning {
            color: var(--color-success);
            padding: var(--spacing-lg);
            text-align: center;
            font-size: var(--font-size-lg);
        }

        .content {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-4xl);
            width: 100%;
        }

        .summary {
            display: flex;
            gap: var(--spacing-lg);
            width: 100%;
            justify-content: space-between;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            padding: var(--spacing-2xl);
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-2xl);
            border: 1px dashed var(--color-border-dashed);
            text-align: center;
            flex: 1;
            min-height: 180px;
            justify-content: center;
        }

        .summary-card-new-km {
            background-color: rgba(220, 38, 38, 0.25);
            border-color: rgba(220, 38, 38, 0.5);
        }

        .summary-card-new-cm {
            background-color: rgba(255, 140, 0, 0.25);
            border-color: rgba(255, 140, 0, 0.5);
        }

        .summary-card-done {
            background-color: rgba(114, 177, 86, 0.25);
            border-color: rgba(114, 177, 86, 0.5);
        }

        .summary-number {
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-semibold);
            line-height: 1.2;
        }

        .summary-label {
            font-size: var(--font-size-xl);
            color: var(--color-secondary);
            line-height: 1.3;
        }

        .files-wrapper {
            border-radius: var(--radius-2xl);
            border: 1px dashed var(--color-border-dashed);
            width: 100%;
        }

        .files-none {
            text-align: center;
            padding: var(--spacing-3xl);
            color: var(--color-tertiary);
        }

        .indicator {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-md);
            text-align: center;
            display: inline-block;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
        }

        .status-completed {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--color-success);
        }

        .status-in-progress {
            background-color: rgba(255, 140, 0, 0.1);
            color: var(--color-primary);
        }

        .status-available {
            background-color: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .urgency-high {
            background-color: rgba(220, 38, 38, 0.1);
            color: var(--color-danger);
        }

        .urgency-medium {
            background-color: rgba(255, 140, 0, 0.1);
            color: var(--color-primary);
        }

        .urgency-low {
            background-color: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .file-name {
            display: block;
            text-align: left;
            font-weight: var(--font-weight-semibold);
        }

        .file-days-high {
            background-color: rgba(220, 38, 38, 0.1);
            color: var(--color-danger);
            font-weight: var(--font-weight-semibold);
        }

        .file-days-medium {
            background-color: rgba(255, 140, 0, 0.1);
            color: var(--color-primary);
            font-weight: var(--font-weight-semibold);
        }

        .file-days-low {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--color-success);
        }

        .completion-date-past {
            color: var(--color-danger);
            font-weight: var(--font-weight-semibold);
        }

        .completion-date-soon {
            color: var(--color-primary);
        }

        .completion-date-future {
            color: var(--color-success);
        }

        .completion-date-normal {
            color: var(--color-secondary);
        }

        .chart-controls {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .chart-btn-active {
            background: var(--color-dark);
            border-color: var(--color-dark);
            color: var(--color-white);
            cursor: default;
        }

        .chart-btn-active:hover {
            background: var(--color-dark);
            color: var(--color-white);
        }

        .chart-data {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
            height: var(--chart-height);
            color: var(--color-tertiary);
        }

        .chart-data-none {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: var(--font-size-base);
            color: var(--color-tertiary);
        }

        .chart-stats {
            display: flex;
            gap: var(--spacing-lg);
            width: 100%;
            margin-top: var(--spacing-2xl);
        }

        .chart-stat-item {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-2xl);
            border: 1px dashed var(--color-border-dashed);
            text-align: center;
            padding: var(--spacing-lg);
            width: 25%;
            justify-content: center;
            min-height: 120px;
        }

        .chart-stat-number {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
        }

        .chart-stat-label {
            font-size: var(--font-size-lg);
            color: var(--color-secondary);
        }

        .footer-info {
            text-align: center;
            color: var(--color-tertiary);
            padding: var(--spacing-lg);
            font-size: var(--font-size-base);
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg-modal-overlay);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            position: relative;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--color-bg-primary);
            margin: 0 auto;
            max-width: 1200px;
            border-radius: var(--radius-2xl);
            overflow: hidden;
            padding: var(--spacing-2xl);
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-modal {
            font-size: var(--font-size-2xl);
            background: none;
            border: none;
            cursor: pointer;
            width: var(--modal-close-btn-size);
            height: var(--modal-close-btn-size);
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            right: var(--spacing-lg);
            top: var(--spacing-lg);
            z-index: 1001;
            color: var(--color-secondary);
            border-radius: var(--radius-circle);
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background-color: var(--color-bg-tertiary);
            color: var(--color-danger);
        }

        .timeline-container {
            width: 100%;
            display: flex;
            gap: var(--spacing-lg);
            justify-content: space-between;
            margin: var(--spacing-2xl) 0;
        }

        .timeline-step {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            padding: var(--spacing-xl);
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-2xl);
            border: 1px dashed var(--color-border-dashed);
            text-align: center;
            align-items: center;
            width: 25%;
        }

        .timeline-step-marker {
            background: var(--color-primary);
            color: var(--color-white);
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            width: var(--timeline-step-marker-size);
            height: var(--timeline-step-marker-size);
            border-radius: var(--radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-sm);
        }

        .timeline-desc {
            color: var(--color-secondary);
        }

        .notice-content {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            width: 100%;
            margin-bottom: var(--spacing-xl);
        }

        .status-content {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            width: 100%;
        }

        /* Стили для статистики завершенных товаров */
        .completed-stats-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            border-radius: var(--radius-2xl);
            border: 1px dashed var(--color-border-dashed);
            background: var(--color-bg-tertiary);
        }

        .files-count-wrapper {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            position: relative;
        }

        .info-icon {
            color: var(--color-secondary);
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: color 0.3s ease;
        }

        .info-icon:hover {
            color: var(--color-primary);
        }

        .files-tooltip {
            display: none;
            position: absolute;
            bottom: 0;
            left: 0;
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border-dashed);
            border-radius: var(--radius-base);
            padding: var(--spacing-md);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 300px;
            max-width: 500px;
            max-height: 300px;
            overflow-y: auto;
            font-size: var(--font-size-sm);
        }

        .files-tooltip.show {
            display: block;
        }

        .tooltip-title {
            font-weight: var(--font-weight-semibold);
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            width: 450px;
        }

        .file-item {
            padding: var(--spacing-md) 0 var(--spacing-md);
            border-bottom: 1px dashed var(--color-border-dashed);
            word-break: break-all;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item small {
            display: block;
            color: var(--color-tertiary);
            font-size: var(--font-size-sm);
            margin-top: 2px;
        }

        .show-more {
            border-bottom: 1px dashed var(--color-border-dashed);
            cursor: pointer;
        }

        .no-completed-data {
            text-align: center;
            padding: var(--spacing-4xl);
            color: var(--color-tertiary);
            font-size: var(--font-size-lg);
        }

        .month-block {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .month-selector select {
            padding: var(--spacing-sm);
            border-radius: var(--radius-base);
            border: 1px solid var(--color-border-dashed);
            background: var(--color-bg-primary);
            font-size: var(--font-size-base);
            min-width: 200px;
        }
    </style>
</head>

<body>
    <article>
        <div class="wrapper">
            <header class="header">
                <h1><i class="fa fa-chart-pie"></i> Отдел контента</h1>
            </header>

            <div class="menu">
                <button onclick="openModal()" class="menu-button">
                    <i class="fa fa-info-circle" aria-hidden="true"></i> Инструкция по сотрудничеству
                </button>
                <button onclick="openCompletedStatsModal()" class="menu-button">
                    <i class="fa fa-check-circle"></i> Подробная статистика
                </button>
                <button onclick="loadPublicData()" class="menu-button">
                    <i class="fa fa-sync-alt"></i> Обновить данные
                </button>
            </div>
        </div>

        <main class="main">
            <div id="warningMessage" class="main-warning" style="display: none;">
                <span id="warningText"></span>
            </div>

            <div id="errorMessage" class="main-error" style="display: none;">
                <span id="errorText"></span>
            </div>

            <div id="loading" class="main-loading">
                Данные загружаются…
            </div>

            <div id="statsSection" class="content" style="display: none;">
                <section>
                    <h2>Статистика отдела контента</h2>
                    <div class="summary">
                        <div class="summary-item summary-card-new-km">
                            <div class="summary-number" id="managerProductsToAdd">0</div>
                            <div class="summary-label">
                                Количество новых товаров менеджеров
                            </div>
                        </div>

                        <div class="summary-item summary-card-new-cm">
                            <div class="summary-number" id="contentProductsToAdd">0</div>
                            <div class="summary-label">
                                Количество новых товаров контента
                            </div>
                        </div>

                        <div class="summary-item summary-card-done">
                            <div class="summary-number" id="productsAddedThisMonth">0</div>
                            <div class="summary-label">
                                Добавлено товаров в текущем месяце
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <h2>Загрузка товаров от менеджера</h2>
                    <p>Ассортимент от менеджеров загружается на сайты в первую очердь.</p>
                    <div class="files-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th valign="top">Файл</th>
                                    <th valign="top" width="10%">Товаров</th>
                                    <th valign="top" width="12%">Начало работы</th>
                                    <th valign="top" width="10%">Поступление</th>
                                    <th valign="top" width="10%">Статус</th>
                                    <th valign="top" width="10%">Добавление</th>
                                    <th valign="top" width="10%">Ориентировочное завершение</th>
                                    <th valign="top" width="13%">Срочность</th>
                                </tr>
                            </thead>
                            <tbody id="managerFilesTableBody"></tbody>
                        </table>
                    </div>
                </section>
                <section>
                    <h2>Загрузка товаров контента</h2>
                    <p>Ассортимент загружается отделом контента при отсутвии товаров от менеджеров.</p>
                    <div class="files-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th valign="top">Файл</th>
                                    <th valign="top" width="10%">Товаров</th>
                                    <th valign="top" width="12%">Начало работы</th>
                                    <th valign="top" width="10%">Статус</th>
                                    <th valign="top" width="10%">Добавление</th>
                                    <th valign="top" valign="top" width="10%">Ориентировочное завершение</th>
                                    <th valign="top" width="13%">Срочность</th>
                                </tr>
                            </thead>
                            <tbody id="contentFilesTableBody"></tbody>
                        </table>
                    </div>
                </section>
                <section>
                    <h2>Завершенные товары по месяцам</h2>
                    <div class="chart-controls">
                        <button class="chart-btn-active" onclick="changeChartType('monthly')" id="btnMonthly">
                            <i class="fa fa-calendar-alt"></i> По месяцам
                        </button>
                        <button onclick="changeChartType('quarterly')" id="btnQuarterly">
                            <i class="fa fa-chart-line"></i> По кварталам
                        </button>
                        <button onclick="changeChartType('yearly')" id="btnYearly">
                            <i class="fa fa-chart-area"></i> По годам
                        </button>
                    </div>

                    <div class="chart-data">
                        <canvas id="monthlyChart"></canvas>
                        <div id="noDataMessage" class="chart-data-none" style="display: none;">
                            Нет данных о завершенных товарах
                        </div>
                    </div>

                    <div class="chart-stats">
                        <div class="chart-stat-item">
                            <div class="chart-stat-number" id="statTotal">0</div>
                            <div class="chart-stat-label">Всего добавлено товаров</div>
                        </div>
                        <div class="chart-stat-item">
                            <div class="chart-stat-number" id="statAvg">0</div>
                            <div class="chart-stat-label">Среднее в месяц</div>
                        </div>
                        <div class="chart-stat-item">
                            <div class="chart-stat-number" id="statMax">0</div>
                            <div class="chart-stat-label">Максимум в месяц</div>
                        </div>
                        <div class="chart-stat-item">
                            <div class="chart-stat-number" id="statCurrent">0</div>
                            <div class="chart-stat-label">Текущий месяц</div>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <footer>
            <div class="footer-info">
                Тестовая версия 0.4. Разработано отделом эл. коммерции.
                Последнее обновление данных: <span id="lastUpdateTime">загружается</span>.
            </div>
        </footer>

        <div id="infoModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal()">&times;</button>
                <section>
                    <h3>Инструкция по сотрудничеству отдела контента и коммерческого отдела</h3>
                    <!--
                    <div class="timeline-container">
                        <div class="timeline-step">
                            <div class="timeline-step-marker">1</div>
                            <h4>Подготовка</h4>
                            <p class="timeline-desc">Менеджер формирует шаблон для добавления товаров со своего
                                файла из папки «КАМ_работаем_здесь»</p>
                        </div>
                        <div class="timeline-step">
                            <div class="timeline-step-marker">2</div>
                            <h4>Сбор данных</h4>
                            <p class="timeline-desc">Менеджером запрашивается информация о товарах и фото у поставщика
                            </p>
                        </div>
                        <div class="timeline-step">
                            <div class="timeline-step-marker">3</div>
                            <h4>Передача</h4>
                            <p class="timeline-desc">Менеджер <a class="show-more"
                                    href="mailto:content@palas.by">передает</a>
                                подготовленный материал в отдел контента</p>
                        </div>
                        <div class="timeline-step">
                            <div class="timeline-step-marker">4</div>
                            <h4>Обработка</h4>
                            <p class="timeline-desc">Срок размещения материала зависит от кол-ва и качества данных.</p>
                        </div>
                    </div>
                    -->
                </section>
                <section>
                    <h3>Добавление товаров в открытые на сайтах товарные группы</h3>
                    <div class="notice-content">
                        <p><b>Основной процесс (инициатива отдела контента)</b></p>
                        <p>Товары на сайте размещает отдела контента, в чью обязанность входит: найти необходимую и
                            достоверную информацию о товаре (характеристики и фото), максимально качественно информацию и загрузить
                            ее на сайт.</p>
                        <p>При отсутствии заявок от менеджеров отдел контента самостоятельно добавляет новые товары в
                            открытые товарные группы. В качестве источника информации используются файлы из папки
                            «КАМ_работаем_здесь». Приоритетность добавления согласуется дополнительно.</p>
                    </div>
                    <div class="notice-content">
                        <p><b>Процесс работы по запросу менеджера</b></p>
                        <p>Чтобы добавить товары в открытые товарные группы, менеджеру необходимо <a class="show-more"
                                href="mailto:content@palas.by">отправить заявку</a> в отдел контента.</p>
                        <p>Обязательная информация в заявке:</p>
                        <ul>
                            <li>Название товарной группы.</li>
                            <li>Список товаров для добавления (указать всю группу, бренд или производителя — достаточно
                                информации для однозначной идентификации товаров).</li>
                        </ul>
                        <p><i>Рекомендация: По сезонным товарам направляйте заявки заблаговременно.</i></p>
                    </div>
                    <div class="notice-content">
                        <p><b>Дополнительные возможности для ускорения (по желанию менеджера)</b></p>
                        <p>Для максимально быстрого выполнения заявки менеджер может предоставить:</p>
                        <ul>
                            <li>Ссылки на сайты-источники (реферальные сайты) с описаниями и фото.</li>
                            <li>Контакты поставщика, у которого можно запросить информацию.</li>
                            <li>Запросить у контент-редактора шаблон файла для самостоятельного заполнения или для
                                отправки его поставщику.</li>
                        </ul>
                    </div>
                    <div class="notice-content">
                        <p><b>Контроль и обучение</b></p>
                        <uL>
                            <li>Все поступившие заявки обрабатываются в порядке очереди. Актуальный статус, очередь и планируемые сроки выполнения отображаются в разделе «Загрузка товаров от менеджера».</li>
                            <li>По запросу менеджера отдел контента готов провести обучение по работе с товарными файлами. Это позволит вам самостоятельно контролировать свойства товаров, фильтры, качество фотографий и выполнять выгрузку.</li>
                        </uL>
                    </div>
                </section>
            </div>
        </div>

        <!-- Модальное окно статистики завершенных товаров -->
        <div id="completedStatsModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeCompletedStatsModal()">&times;</button>
                <section>
                    <h3>Подробная статистика по товаром добавленным в группы</h3>

                    <div class="month-block">
                        <p>
                            Добавлено товаров по группе 3 за период:
                        </p>
                        <div class="month-selector">
                            <select id="monthSelect"></select>
                        </div>
                    </div>

                    <div id="completedStatsContent" class="status-content">
                        <div class="no-completed-data">
                            Данные загружаются…
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </article>

    <script>
        const SPREADSHEET_ID = '1vCZQgzBPv8uahr8ckRI1f-TA_QS6Afz2B9NP_ZMj6ek';
        const PUBLIC_SPREADSHEET_ID = '2PACX-1vT2AYh3Iqgf07HInfdc3bQwE_L3AweAonhdE7LlJlJtBHo_5rx3WVko0Pdm5eGjCvmcjTOWja8nP20O';
        const MANAGER_SHEET_GID = '1367779997';
        const CONTENT_SHEET_GID = '33531424';

        let managerProductsToAdd = 0;
        let contentProductsToAdd = 0;
        let productsAddedThisMonth = 0;
        let managerFilesForProcessing = [];
        let contentFilesForProcessing = [];
        let monthlyCompletedData = {};
        let chart = null;
        let currentChartType = 'monthly';
        let availableMonths = [];
        let isDataLoaded = false;

        // Основные функции модальных окон
        function openModal() {
            document.getElementById('infoModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('infoModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function openCompletedStatsModal() {
            document.getElementById('completedStatsModal').style.display = 'block';
            document.body.style.overflow = 'hidden';

            // Если данные уже загружены, сразу загружаем статистику
            if (isDataLoaded) {
                loadCompletedStats();
            } else {
                // Показываем сообщение о загрузке
                const contentElement = document.getElementById('completedStatsContent');
                contentElement.innerHTML = '<div class="no-completed-data">Загрузка данных... Пожалуйста, подождите.</div>';

                // Пытаемся загрузить данные, если они еще не загружены
                loadPublicData().then(() => {
                    // После загрузки данных загружаем статистику
                    loadCompletedStats();
                });
            }
        }

        function closeCompletedStatsModal() {
            document.getElementById('completedStatsModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            // Закрываем все открытые тултипы при закрытии модального окна
            document.querySelectorAll('.files-tooltip.show').forEach(tooltip => {
                tooltip.classList.remove('show');
            });
        }

        // Обработчики кликов вне модальных окон
        window.onclick = function (event) {
            const modal = document.getElementById('infoModal');
            const completedModal = document.getElementById('completedStatsModal');

            if (event.target == modal) closeModal();
            if (event.target == completedModal) closeCompletedStatsModal();

            // Закрываем тултипы при клике вне их
            if (!event.target.closest('.files-count-wrapper')) {
                document.querySelectorAll('.files-tooltip.show').forEach(tooltip => {
                    tooltip.classList.remove('show');
                });
            }
        }

        // Обработчик клавиши Escape
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeModal();
                closeCompletedStatsModal();
            }
        });

        // Вспомогательные функции
        function updateLoadingDetails(text) {
            const loading = document.getElementById('loading');
            if (loading && text) {
                loading.textContent = `${text}`;
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            const dateString = now.toLocaleDateString('ru-RU');
            document.getElementById('lastUpdateTime').textContent = `${dateString} ${timeString}`;
        }

        function changeChartType(type) {
            currentChartType = type;
            document.querySelectorAll('.chart-controls button').forEach(btn => {
                btn.classList.remove('chart-btn-active');
            });
            document.getElementById(`btn${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('chart-btn-active');
            updateChart();
        }

        function calculateDaysToAdd(productsCount) {
            if (productsCount <= 0) return 0;
            return Math.ceil(productsCount / 50);
        }

        function getDaysClass(days) {
            if (days >= 10) return 'file-days-high';
            if (days >= 5) return 'file-days-medium';
            return 'file-days-low';
        }

        function calculateCompletionDate(startDate, daysToAdd) {
            if (!startDate || startDate === 'Не указано' || startDate === '-' || daysToAdd <= 0) {
                return '';
            }

            try {
                const parts = startDate.split('.');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);

                    if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                        const start = new Date(year, month, day);
                        let currentDate = new Date(start);
                        let daysAdded = 0;

                        while (daysAdded < daysToAdd) {
                            currentDate.setDate(currentDate.getDate() + 1);
                            const dayOfWeek = currentDate.getDay();
                            if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                                daysAdded++;
                            }
                        }

                        const resultDay = currentDate.getDate().toString().padStart(2, '0');
                        const resultMonth = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                        const resultYear = currentDate.getFullYear();

                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const completionDate = new Date(resultYear, currentDate.getMonth(), currentDate.getDate());

                        const diffTime = completionDate.getTime() - today.getTime();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        let dateClass = 'completion-date-normal';
                        if (diffDays < 0) {
                            dateClass = 'completion-date-past';
                        } else if (diffDays <= 3) {
                            dateClass = 'completion-date-soon';
                        } else if (diffDays > 3) {
                            dateClass = 'completion-date-future';
                        }

                        return `<span class="${dateClass}">${resultDay}.${resultMonth}.${resultYear}</span>`;
                    }
                }
                return '-';
            } catch (e) {
                console.error('Ошибка вычисления даты завершения:', e);
                return '-';
            }
        }

        // Основная функция загрузки данных
        async function loadPublicData() {
            const loading = document.getElementById('loading');
            const statsSection = document.getElementById('statsSection');
            const warningMessage = document.getElementById('warningMessage');
            const errorMessage = document.getElementById('errorMessage');

            loading.style.display = 'block';
            statsSection.style.display = 'none';
            warningMessage.style.display = 'none';
            errorMessage.style.display = 'none';

            try {
                managerProductsToAdd = 0;
                contentProductsToAdd = 0;
                productsAddedThisMonth = 0;
                managerFilesForProcessing = [];
                contentFilesForProcessing = [];
                monthlyCompletedData = {};

                updateLoadingDetails('Загрузка данных менеджеров…');
                const managerData = await loadSheetData('manager');
                if (managerData && managerData.length > 1) {
                    processData(managerData, 'manager');
                }

                updateLoadingDetails('Загрузка данных контента…');
                const contentData = await loadSheetData('content');
                if (contentData && contentData.length > 1) {
                    processData(contentData, 'content');
                }

                updateDisplay();
                updateLastUpdateTime();
                updateChart();

                loading.style.display = 'none';
                statsSection.style.display = 'flex';
                isDataLoaded = true;

                if (managerFilesForProcessing.length > 0 || contentFilesForProcessing.length > 0 || Object.keys(monthlyCompletedData).length > 0) {
                    warningMessage.style.display = 'block';
                    warningMessage.textContent = 'Данные успешно загружены.';
                    setTimeout(() => warningMessage.style.display = 'none', 3000);
                }

            } catch (error) {
                console.error('Ошибка загрузки:', error);
                loading.style.display = 'none';
                statsSection.style.display = 'flex';
                errorMessage.style.display = 'block';
                document.getElementById('errorText').textContent = `Ошибка: ${error.message}. Попробуйте обновить данные.`;
                isDataLoaded = false;
            }
        }

        // Загрузка данных из Google Sheets
        async function loadSheetData(source) {
            const gid = source === 'manager' ? MANAGER_SHEET_GID : CONTENT_SHEET_GID;
            const urls = [
                `https://docs.google.com/spreadsheets/d/e/${PUBLIC_SPREADSHEET_ID}/pub?gid=${gid}&single=true&output=csv`,
                `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${gid}`,
                `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/pub?gid=${gid}&single=true&output=csv`,
                `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`,
            ];

            for (let i = 0; i < urls.length; i++) {
                try {
                    const timestamp = new Date().getTime();
                    const finalUrl = `${urls[i]}${urls[i].includes('?') ? '&' : '?'}_=${timestamp}`;
                    const response = await fetch(finalUrl);

                    if (!response.ok) continue;

                    const text = await response.text();
                    if (!text || text.trim() === '' || text.includes('<!DOCTYPE') || text.includes('<html')) continue;

                    const rows = parseCSV(text);
                    if (rows.length > 0) return rows;
                } catch (error) {
                    continue;
                }
            }
            return [];
        }

        function parseCSV(csvText) {
            if (csvText.includes('google.visualization.Query.setResponse')) {
                try {
                    const jsonStart = csvText.indexOf('{');
                    const jsonEnd = csvText.lastIndexOf('}') + 1;
                    const jsonText = csvText.substring(jsonStart, jsonEnd);
                    const data = JSON.parse(jsonText);

                    const rows = [];
                    if (data.table && data.table.cols && data.table.rows) {
                        const headers = data.table.cols.map(col => col.label || '');
                        rows.push(headers);

                        data.table.rows.forEach(row => {
                            const rowData = row.c.map(cell => cell ? cell.v || '' : '');
                            rows.push(rowData);
                        });
                    }
                    return rows;
                } catch (error) {
                    // Продолжаем с обычным парсингом CSV
                }
            }

            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;

            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentField.trim());
                    currentField = '';
                } else if (char === '\n' && !inQuotes) {
                    currentRow.push(currentField.trim());
                    rows.push(currentRow);
                    currentRow = [];
                    currentField = '';
                } else if (char === '\r') {
                    continue;
                } else {
                    currentField += char;
                }
            }

            if (currentField !== '' || currentRow.length > 0) {
                currentRow.push(currentField.trim());
                rows.push(currentRow);
            }

            return rows;
        }

        function processData(rows, source) {
            if (rows.length < 2) return;

            const headers = rows[0];
            const indices = {
                status: findColumnIndex(headers, ['Статус группы', 'Статус', 'Состояние', 'Status']),
                products: findColumnIndex(headers, ['Количество товаров', 'Количество', 'Товары', 'Кол-во товаров', 'Products', 'Count']),
                filename: findColumnIndex(headers, ['Имя файла', 'Файл', 'Название', 'Название файла', 'File', 'Filename']),
                date: findColumnIndex(headers, ['Дата взятия', 'Дата', 'Дата создания', 'Date']),
                managerDate: findColumnIndex(headers, ['Дата добавления файла', 'Дата от менеджера', 'Дата прихода', 'Дата получения']),
                urgency: findColumnIndex(headers, ['Срочность', 'Приоритет', 'Важность', 'Urgency', 'Priority']),
                completionDate: findColumnIndex(headers, ['Дата завершения работы', 'Дата завершения', 'Дата окончания', 'Completion Date']),
                group3: findColumnIndex(headers, ['Группа 3', 'Группа', 'Категория', 'Group 3', 'Category'])
            };

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.length === 0) continue;

                const analysis = analyzeRow(row, indices, source);

                if (analysis.filename && analysis.filename !== '') {
                    const daysToAdd = calculateDaysToAdd(analysis.productsCount);
                    const daysClass = getDaysClass(daysToAdd);

                    const fileData = {
                        filename: analysis.filename,
                        productsCount: analysis.productsCount,
                        status: analysis.status,
                        statusType: analysis.statusType,
                        additionDate: analysis.additionDate,
                        managerAdditionDate: analysis.managerAdditionDate || 'Не указано',
                        urgency: analysis.urgency,
                        urgencyClass: getUrgencyClass(analysis.urgency),
                        daysToAdd: daysToAdd,
                        daysClass: daysClass,
                        source: source,
                        group3: analysis.group3,
                        completionDate: analysis.completionDate
                    };

                    if (source === 'manager') {
                        if (analysis.statusType !== 'completed' && analysis.statusType !== 'unknown') {
                            managerFilesForProcessing.push(fileData);
                            managerProductsToAdd += analysis.productsCount;
                        }
                        if (analysis.statusType === 'completed' && analysis.completionMonthYear) {
                            addToMonthlyData(analysis.completionMonthYear, analysis.productsCount, analysis.completionYear, analysis.completionQuarter);
                            if (analysis.isCurrentMonth) {
                                productsAddedThisMonth += analysis.productsCount;
                            }
                        }
                    } else {
                        if (analysis.statusType !== 'completed' && analysis.statusType !== 'unknown') {
                            contentFilesForProcessing.push(fileData);
                            contentProductsToAdd += analysis.productsCount;
                        }
                        if (analysis.statusType === 'completed' && analysis.completionMonthYear) {
                            addToMonthlyData(analysis.completionMonthYear, analysis.productsCount, analysis.completionYear, analysis.completionQuarter);
                            if (analysis.isCurrentMonth) {
                                productsAddedThisMonth += analysis.productsCount;
                            }
                        }
                    }
                }
            }
        }

        function addToMonthlyData(monthYear, count, year, quarter) {
            if (!monthlyCompletedData[monthYear]) {
                monthlyCompletedData[monthYear] = {
                    count: 0,
                    year: year,
                    quarter: quarter
                };
            }
            monthlyCompletedData[monthYear].count += count;
        }

        function findColumnIndex(headers, columnNames) {
            if (!headers) return -1;
            for (const columnName of columnNames) {
                const index = headers.findIndex(header =>
                    header && header.toString().toLowerCase().includes(columnName.toLowerCase())
                );
                if (index !== -1) return index;
            }
            return -1;
        }

        function analyzeRow(row, indices, source) {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            const result = {
                status: '',
                statusType: 'unknown',
                productsCount: 0,
                filename: '',
                additionDate: 'Не указано',
                managerAdditionDate: 'Не указано',
                urgency: '',
                group3: '',
                completionMonthYear: null,
                completionYear: null,
                completionQuarter: null,
                isCurrentMonth: false,
                completionDate: ''
            };

            if (indices.status !== -1 && row[indices.status]) {
                result.status = row[indices.status].toString().trim();
                result.statusType = determineStatusType(result.status);
            }

            if (indices.products !== -1 && row[indices.products]) {
                const str = row[indices.products].toString().trim();
                const num = parseFloat(str.replace(/[^\d.,]/g, '').replace(',', '.'));
                result.productsCount = isNaN(num) ? 0 : Math.round(num);
            }

            if (indices.filename !== -1 && row[indices.filename]) {
                result.filename = row[indices.filename].toString().trim();
            }

            if (indices.date !== -1 && row[indices.date]) {
                const dateStr = row[indices.date].toString().trim();
                result.additionDate = formatDate(dateStr);
            }

            if (source === 'manager' && indices.managerDate !== -1 && row[indices.managerDate]) {
                const managerDateStr = row[indices.managerDate].toString().trim();
                result.managerAdditionDate = formatDate(managerDateStr);
            }

            if (indices.urgency !== -1 && row[indices.urgency]) {
                result.urgency = row[indices.urgency].toString().trim();
                if (result.urgency === '') result.urgency = 'Не указано';
            }

            if (indices.group3 !== -1 && row[indices.group3]) {
                result.group3 = row[indices.group3].toString().trim();
            }

            if (indices.completionDate !== -1 && row[indices.completionDate]) {
                const dateStr = row[indices.completionDate].toString().trim();
                if (dateStr) {
                    result.completionDate = formatDate(dateStr);
                    try {
                        const dateOnly = dateStr.split(' ')[0];
                        const parts = dateOnly.split(/[\.\/-]/);

                        if (parts.length === 3) {
                            const day = parseInt(parts[0], 10);
                            const month = parseInt(parts[1], 10) - 1;
                            const year = parts[2].length === 2 ? 2000 + parseInt(parts[2], 10) : parseInt(parts[2], 10);

                            if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                                result.isCurrentMonth = (month === currentMonth && year === currentYear);

                                const monthNames = [
                                    'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                                    'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
                                ];
                                const monthName = monthNames[month];
                                result.completionMonthYear = `${monthName} ${year}`;
                                result.completionYear = year;
                                result.completionQuarter = Math.floor(month / 3) + 1;
                            }
                        }
                    } catch (e) {
                        console.warn('Ошибка парсинга даты завершения:', e);
                    }
                }
            }

            return result;
        }

        function determineStatusType(status) {
            if (!status) return 'unknown';
            const statusLower = status.toLowerCase();

            if (status.includes('✅') || status.includes('✔') || status.includes('✓') ||
                status.includes('☑') || status.includes('🎯')) {
                return 'completed';
            }
            if (status.includes('🔄') || status.includes('⚙️') || status.includes('⏳') ||
                status.includes('📊') || status.includes('👨‍💻')) {
                return 'in_progress';
            }
            if (status.includes('🆕') || status.includes('📄') || status.includes('📋') ||
                status.includes('📁') || status.includes('📂')) {
                return 'available';
            }

            if (statusLower.includes('заверш') || statusLower.includes('выполн') ||
                statusLower.includes('готов') || statusLower.includes('сделан') ||
                statusLower.includes('done') || statusLower.includes('completed') ||
                statusLower.includes('готово') || statusLower.includes('закрыт')) {
                return 'completed';
            } else if (statusLower.includes('доступ') || statusLower.includes('нов') ||
                statusLower.includes('ожидан') || statusLower.includes('available') ||
                statusLower.includes('новая') || statusLower.includes('ожидает')) {
                return 'available';
            } else if (statusLower.includes('работ') || statusLower.includes('в проц') ||
                statusLower.includes('обработ') || statusLower.includes('in progress') ||
                statusLower.includes('выполняется') || statusLower.includes('актив')) {
                return 'in_progress';
            }

            return 'unknown';
        }

        function getUrgencyClass(urgencyText) {
            if (!urgencyText) return 'urgency-low';
            const urgencyLower = urgencyText.toLowerCase();
            if (urgencyLower.includes('высок') || urgencyLower.includes('срочн') ||
                urgencyLower.includes('urgent') || urgencyLower.includes('high') ||
                urgencyLower.includes('критич') || urgencyLower.includes('важн')) {
                return 'urgency-high';
            } else if (urgencyLower.includes('серед') || urgencyLower.includes('medium') ||
                urgencyLower.includes('norm') || urgencyLower.includes('обыч')) {
                return 'urgency-medium';
            } else {
                return 'urgency-low';
            }
        }

        function formatDate(dateString) {
            if (!dateString || dateString.trim() === '') {
                return 'Не указано';
            }

            try {
                const dateStr = dateString.trim();
                const parts = dateStr.split(/[\.\/-]/);
                if (parts.length >= 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parts[2].length === 2 ? 2000 + parseInt(parts[2], 10) : parseInt(parts[2], 10);

                    if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                        const date = new Date(year, month, day);
                        const formattedDay = date.getDate().toString().padStart(2, '0');
                        const formattedMonth = (date.getMonth() + 1).toString().padStart(2, '0');
                        const formattedYear = date.getFullYear();
                        return `${formattedDay}.${formattedMonth}.${formattedYear}`;
                    }
                }

                const parsedDate = new Date(dateStr);
                if (!isNaN(parsedDate.getTime())) {
                    const day = parsedDate.getDate().toString().padStart(2, '0');
                    const month = (parsedDate.getMonth() + 1).toString().padStart(2, '0');
                    const year = parsedDate.getFullYear();
                    return `${day}.${month}.${year}`;
                }

                return dateStr;
            } catch (e) {
                return dateString;
            }
        }

        function updateDisplay() {
            document.getElementById('managerProductsToAdd').textContent = managerProductsToAdd;
            document.getElementById('contentProductsToAdd').textContent = contentProductsToAdd;
            document.getElementById('productsAddedThisMonth').textContent = productsAddedThisMonth;

            updateManagerTable();
            updateContentTable();
        }

        function updateManagerTable() {
            const tableBody = document.getElementById('managerFilesTableBody');
            tableBody.innerHTML = '';

            if (managerFilesForProcessing.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="files-none">
                            Нет файлов для обработки менеджеров
                        </td>
                    </tr>
                `;
                return;
            }

            managerFilesForProcessing.forEach(file => {
                const statusClass = `status-${file.statusType.replace('_', '-')}`;
                const statusText = getStatusText(file.statusType);
                const urgencyClass = file.urgencyClass || 'urgency-low';
                const urgencyText = file.urgency || 'Не указано';
                const daysText = file.daysToAdd > 0 ? `${file.daysToAdd} дн.` : '0 дн.';
                const completionDate = calculateCompletionDate(file.additionDate, file.daysToAdd);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="file-name">${file.filename}</span></td>
                    <td>${file.productsCount}</td>
                    <td>${file.additionDate}</td>
                    <td>${file.managerAdditionDate}</td>
                    <td><span class="indicator ${statusClass}">${statusText}</span></td>
                    <td><span class="indicator ${file.daysClass}">${daysText}</span></td>
                    <td>${completionDate}</td>
                    <td><span class="indicator ${urgencyClass}">${urgencyText}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateContentTable() {
            const tableBody = document.getElementById('contentFilesTableBody');
            tableBody.innerHTML = '';

            if (contentFilesForProcessing.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="files-none">
                            Нет файлов для обработки контента
                        </td>
                    </tr>
                `;
                return;
            }

            contentFilesForProcessing.forEach(file => {
                const statusClass = `status-${file.statusType.replace('_', '-')}`;
                const statusText = getStatusText(file.statusType);
                const urgencyClass = file.urgencyClass || 'urgency-low';
                const urgencyText = file.urgency || 'Не указано';
                const daysText = file.daysToAdd > 0 ? `${file.daysToAdd} дн.` : '0 дн.';
                const completionDate = calculateCompletionDate(file.additionDate, file.daysToAdd);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="file-name">${file.filename}</span></td>
                    <td>${file.productsCount}</td>
                    <td>${file.additionDate}</td>
                    <td><span class="indicator ${statusClass}">${statusText}</span></td>
                    <td><span class="indicator ${file.daysClass}">${daysText}</span></td>
                    <td>${completionDate}</td>
                    <td><span class="indicator ${urgencyClass}">${urgencyText}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function getStatusText(statusType) {
            switch (statusType) {
                case 'in_progress': return 'В работе';
                case 'available': return 'Доступно';
                case 'completed': return 'Завершено';
                default: return 'Неизвестно';
            }
        }

        // Функции для графика
        function prepareChartData() {
            const entries = Object.entries(monthlyCompletedData);
            if (entries.length === 0) {
                return { labels: [], data: [] };
            }

            entries.sort((a, b) => {
                const [monthYearA] = a;
                const [monthYearB] = b;
                const [monthA, yearA] = monthYearA.split(' ');
                const [monthB, yearB] = monthYearB.split(' ');

                const monthOrder = {
                    'Январь': 1, 'Февраль': 2, 'Март': 3, 'Апрель': 4,
                    'Май': 5, 'Июнь': 6, 'Июль': 7, 'Август': 8,
                    'Сентябрь': 9, 'Октябрь': 10, 'Ноябрь': 11, 'Декабрь': 12
                };

                if (parseInt(yearA) !== parseInt(yearB)) {
                    return parseInt(yearA) - parseInt(yearB);
                }
                return monthOrder[monthA] - monthOrder[monthB];
            });

            let labels = [];
            let data = [];

            if (currentChartType === 'monthly') {
                labels = entries.map(entry => entry[0]);
                data = entries.map(entry => entry[1].count);
            } else if (currentChartType === 'quarterly') {
                const quarterlyData = {};
                entries.forEach(([monthYear, info]) => {
                    const quarterKey = `Q${info.quarter} ${info.year}`;
                    if (!quarterlyData[quarterKey]) {
                        quarterlyData[quarterKey] = 0;
                    }
                    quarterlyData[quarterKey] += info.count;
                });

                const quarterEntries = Object.entries(quarterlyData).sort((a, b) => {
                    const [quarterA, yearA] = a[0].split(' ');
                    const [quarterB, yearB] = b[0].split(' ');
                    if (parseInt(yearA) !== parseInt(yearB)) {
                        return parseInt(yearA) - parseInt(yearB);
                    }
                    return parseInt(quarterA.substring(1)) - parseInt(quarterB.substring(1));
                });

                labels = quarterEntries.map(entry => entry[0]);
                data = quarterEntries.map(entry => entry[1]);
            } else if (currentChartType === 'yearly') {
                const yearlyData = {};
                entries.forEach(([monthYear, info]) => {
                    const yearKey = `${info.year}`;
                    if (!yearlyData[yearKey]) {
                        yearlyData[yearKey] = 0;
                    }
                    yearlyData[yearKey] += info.count;
                });

                const yearEntries = Object.entries(yearlyData).sort((a, b) =>
                    parseInt(a[0]) - parseInt(b[0])
                );

                labels = yearEntries.map(entry => entry[0]);
                data = yearEntries.map(entry => entry[1]);
            }

            return { labels, data };
        }

        function updateStats(chartData) {
            const { labels, data } = chartData;

            if (data.length === 0) {
                document.getElementById('statTotal').textContent = '0';
                document.getElementById('statAvg').textContent = '0';
                document.getElementById('statMax').textContent = '0';
                document.getElementById('statCurrent').textContent = '0';
                return;
            }

            const total = data.reduce((sum, value) => sum + value, 0);
            const avg = Math.round(total / data.length);
            const max = Math.max(...data);

            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            const currentMonthYear = `${monthNames[currentMonth]} ${currentYear}`;
            const currentMonthData = monthlyCompletedData[currentMonthYear] ? monthlyCompletedData[currentMonthYear].count : 0;

            document.getElementById('statTotal').textContent = total.toLocaleString('ru-RU');
            document.getElementById('statAvg').textContent = avg.toLocaleString('ru-RU');
            document.getElementById('statMax').textContent = max.toLocaleString('ru-RU');
            document.getElementById('statCurrent').textContent = currentMonthData.toLocaleString('ru-RU');
        }

        function updateChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            const noDataMessage = document.getElementById('noDataMessage');

            const chartData = prepareChartData();
            const { labels, data } = chartData;

            updateStats(chartData);

            if (labels.length === 0 || data.length === 0) {
                noDataMessage.style.display = 'block';
                if (chart) {
                    chart.destroy();
                    chart = null;
                }
                return;
            }

            noDataMessage.style.display = 'none';

            if (chart) {
                chart.data.labels = labels;
                chart.data.datasets[0].data = data;
                chart.update();
            } else {
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Завершенные товары',
                            data: data,
                            backgroundColor: '#ff8c00',
                            borderColor: '#ff8c00',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `Количество: ${context.raw.toLocaleString('ru-RU')}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return value.toLocaleString('ru-RU');
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Количество товаров'
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            }
                        }
                    }
                });
            }
        }

        // Функции для статистики завершенных товаров
        async function loadCompletedStats() {
            const contentElement = document.getElementById('completedStatsContent');

            // Проверяем, есть ли данные
            if (!isDataLoaded || Object.keys(monthlyCompletedData).length === 0) {
                contentElement.innerHTML = '<div class="no-completed-data">Данные еще не загружены. Загружаем...</div>';

                // Если данные не загружены, загружаем их
                if (!isDataLoaded) {
                    try {
                        await loadPublicData();
                        // После загрузки данных загружаем статистику
                        await loadCompletedStatsReal();
                    } catch (error) {
                        contentElement.innerHTML = `
                            <div class="no-completed-data" style="color: var(--color-danger);">
                                Ошибка загрузки данных. Попробуйте обновить страницу.
                            </div>
                        `;
                    }
                } else {
                    // Если флаг установлен, но данных нет, пытаемся загрузить статистику
                    await loadCompletedStatsReal();
                }
            } else {
                // Если данные есть, загружаем статистику
                await loadCompletedStatsReal();
            }
        }

        // Создаем отдельную функцию для загрузки статистики (чтобы избежать рекурсии)
        async function loadCompletedStatsReal() {
            const contentElement = document.getElementById('completedStatsContent');
            contentElement.innerHTML = '<div class="no-completed-data">Данные загружаются…</div>';

            try {
                // Определяем выбранный месяц
                const monthSelect = document.getElementById('monthSelect');
                const selectedValue = monthSelect.value;
                let selectedMonth, selectedYear;

                if (selectedValue === 'current') {
                    const currentDate = new Date();
                    selectedMonth = currentDate.getMonth() + 1;
                    selectedYear = currentDate.getFullYear();
                } else {
                    [selectedYear, selectedMonth] = selectedValue.split('-').map(Number);
                }

                // Загружаем данные
                const [managerData, contentData] = await Promise.all([
                    loadCompletedDataFromSheet('manager'),
                    loadCompletedDataFromSheet('content')
                ]);

                // Объединяем и фильтруем данные
                const allData = [...managerData, ...contentData];
                const filteredData = allData.filter(item => {
                    return item.statusType === 'completed' &&
                        item.group3 &&
                        item.completionMonth &&
                        item.completionYear &&
                        item.completionMonth === selectedMonth &&
                        item.completionYear === selectedYear;
                });

                // Группируем по группе 3
                const groupedData = {};
                let totalProducts = 0;
                let totalFiles = 0;

                filteredData.forEach(item => {
                    const groupKey = item.group3;
                    if (!groupedData[groupKey]) {
                        groupedData[groupKey] = {
                            name: item.group3,
                            totalProducts: 0,
                            filesCount: 0,
                            files: []
                        };
                    }

                    groupedData[groupKey].totalProducts += item.productsCount;
                    groupedData[groupKey].filesCount++;
                    groupedData[groupKey].files.push({
                        filename: item.filename,
                        productsCount: item.productsCount,
                        completionDate: item.completionDate,
                        source: item.source
                    });

                    totalProducts += item.productsCount;
                    totalFiles++;
                });

                // Сортируем группы по убыванию количества товаров
                const sortedGroups = Object.values(groupedData).sort((a, b) =>
                    b.totalProducts - a.totalProducts
                );

                // Обновляем селектор месяцев
                updateMonthSelector(allData);

                // Отображаем результаты
                if (sortedGroups.length === 0) {
                    contentElement.innerHTML = `
                        <div class="no-completed-data">
                            Нет завершенных товаров по группе 3 за выбранный период
                        </div>
                    `;
                    return;
                }

                const monthNames = [
                    'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                    'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
                ];
                const monthName = monthNames[selectedMonth - 1];

                let html = `
                    <div class="completed-stats-summary">
                        <div>
                            <b>Период:</b> ${monthName} ${selectedYear}. Всего файлов: ${totalFiles}
                        </div>
                        <div>
                            <b>Всего товаров:</b> ${totalProducts.toLocaleString('ru-RU')}
                        </div>
                    </div>
                    <div class="files-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th valign="top" width="50%">Группа 3</th>
                                    <th valign="top" width="25%">Товаров</th>
                                    <th valign="top" width="25%">Файлов</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                sortedGroups.forEach((group, index) => {
                    // Создаем список файлов для тултипа
                    const filesList = group.files.map((file, fileIndex) =>
                        `<div class="file-item">
                            ${fileIndex + 1}. ${file.filename}<br>
                            Товаров: ${file.productsCount}${file.completionDate ? `. Завершено: ${file.completionDate}` : ''}
                        </div>`
                    ).join('');

                    // Создаем HTML для тултипа
                    const tooltipId = `tooltip-${index}`;
                    const tooltipHTML = `
                        <div class="files-tooltip" id="${tooltipId}">
                            <div class="tooltip-title">Файлы в группе "${group.name}"</div>
                            <div class="file-list">
                                ${filesList}
                            </div>
                        </div>
                    `;

                    html += `
                        <tr>
                            <td><span class="file-name">${group.name}</span></td>
                            <td>${group.totalProducts.toLocaleString('ru-RU')}</td>
                            <td>
                                <div class="files-count-wrapper">
                                    ${group.filesCount}
                                    <span class="show-more" onclick="toggleTooltip('${tooltipId}', this)">подробнее</span>
                                    ${tooltipHTML}
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                contentElement.innerHTML = html;

            } catch (error) {
                console.error('Ошибка загрузки статистики:', error);
                contentElement.innerHTML = `
                    <div class="no-completed-data" style="color: var(--color-danger);">
                        Ошибка загрузки данных. Попробуйте обновить страницу.
                    </div>
                `;
            }
        }

        // Функция для сохранения выбранного месяца
        function saveSelectedMonth(value) {
            localStorage.setItem('selectedMonthValue', value);
        }

        // Функция для получения сохраненного месяца
        function getSavedSelectedMonth() {
            return localStorage.getItem('selectedMonthValue');
        }

        // Функция для переключения тултипа
        function toggleTooltip(tooltipId, iconElement) {
            const tooltip = document.getElementById(tooltipId);
            const isVisible = tooltip.classList.contains('show');

            // Закрываем все открытые тултипы
            document.querySelectorAll('.files-tooltip.show').forEach(t => {
                t.classList.remove('show');
            });

            // Если текущий тултип не был виден, показываем его
            if (!isVisible) {
                tooltip.classList.add('show');

                // Позиционируем тултип
                const rect = iconElement.getBoundingClientRect();
                const modalContent = document.querySelector('.modal-content');
                const modalRect = modalContent.getBoundingClientRect();

                // Проверяем, помещается ли тултип справа
                if (rect.right + tooltip.offsetWidth <= modalRect.right) {
                    tooltip.style.left = '0';
                    tooltip.style.right = 'auto';
                } else {
                    // Если не помещается справа, показываем слева
                    tooltip.style.left = 'auto';
                    tooltip.style.right = '0';
                }
            }
        }

        async function loadCompletedDataFromSheet(source) {
            const gid = source === 'manager' ? MANAGER_SHEET_GID : CONTENT_SHEET_GID;
            const url = `https://docs.google.com/spreadsheets/d/e/${PUBLIC_SPREADSHEET_ID}/pub?gid=${gid}&single=true&output=csv`;

            try {
                const timestamp = new Date().getTime();
                const finalUrl = `${url}&_=${timestamp}`;
                const response = await fetch(finalUrl);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const text = await response.text();
                const rows = parseCSV(text);

                if (rows.length < 2) {
                    return [];
                }

                const headers = rows[0];
                const completedData = [];

                const indices = {
                    group3: findColumnIndex(headers, ['Группа 3', 'Group 3', 'Товарная группа', 'Категория']),
                    filename: findColumnIndex(headers, ['Имя файла', 'Файл', 'Название файла']),
                    products: findColumnIndex(headers, ['Количество товаров', 'Товары', 'Кол-во']),
                    status: findColumnIndex(headers, ['Статус', 'Статус группы', 'Состояние']),
                    completionDate: findColumnIndex(headers, ['Дата завершения', 'Дата окончания', 'Completion Date'])
                };

                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length === 0) continue;

                    const status = row[indices.status] ? row[indices.status].toString().trim() : '';
                    const statusType = determineStatusType(status);

                    if (statusType === 'completed') {
                        const group3 = row[indices.group3] ? row[indices.group3].toString().trim() : '';
                        const filename = row[indices.filename] ? row[indices.filename].toString().trim() : '';
                        const productsStr = row[indices.products] ? row[indices.products].toString().trim() : '0';
                        const completionDateStr = row[indices.completionDate] ? row[indices.completionDate].toString().trim() : '';

                        const productsCount = parseProductsCount(productsStr);

                        let completionMonth = null;
                        let completionYear = null;
                        let formattedDate = '';

                        if (completionDateStr) {
                            formattedDate = formatDate(completionDateStr);
                            try {
                                const parts = formattedDate.split('.');
                                if (parts.length === 3) {
                                    completionMonth = parseInt(parts[1], 10);
                                    completionYear = parseInt(parts[2], 10);
                                }
                            } catch (e) {
                                // Игнорируем ошибки парсинга даты
                            }
                        }

                        if (group3 && productsCount > 0) {
                            completedData.push({
                                group3: group3,
                                filename: filename,
                                productsCount: productsCount,
                                statusType: statusType,
                                completionDate: formattedDate,
                                completionMonth: completionMonth,
                                completionYear: completionYear,
                                source: source
                            });
                        }
                    }
                }

                return completedData;

            } catch (error) {
                console.error(`Ошибка загрузки данных из ${source}:`, error);
                return [];
            }
        }

        function parseProductsCount(str) {
            if (!str) return 0;
            const cleaned = str.toString().replace(/[^\d.,]/g, '');
            if (!cleaned) return 0;
            const normalized = cleaned.replace(',', '.');
            const num = parseFloat(normalized);
            return isNaN(num) ? 0 : Math.round(num);
        }

        function updateMonthSelector(allData) {
            const monthSelect = document.getElementById('monthSelect');
            const uniqueMonths = new Set();
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1;
            const currentYear = currentDate.getFullYear();

            // Добавляем текущий месяц
            uniqueMonths.add(`current`);

            // Собираем уникальные месяцы из данных
            allData.forEach(item => {
                if (item.completionMonth && item.completionYear) {
                    uniqueMonths.add(`${item.completionYear}-${item.completionMonth}`);
                }
            });

            // Преобразуем в массив и сортируем по убыванию (сначала новые)
            const monthsArray = Array.from(uniqueMonths).sort((a, b) => {
                if (a === 'current') return -1;
                if (b === 'current') return 1;

                const [yearA, monthA] = a.split('-').map(Number);
                const [yearB, monthB] = b.split('-').map(Number);
                if (yearB !== yearA) return yearB - yearA;
                return monthB - monthA;
            });

            // Сохраняем текущее выбранное значение
            const currentSelectedValue = monthSelect.value;

            // Очищаем и заполняем селектор
            monthSelect.innerHTML = '';

            // Добавляем опции
            monthsArray.forEach(monthKey => {
                if (monthKey === 'current') {
                    monthSelect.innerHTML += `<option value="current">Текущий месяц (${getMonthName(currentMonth)} ${currentYear})</option>`;
                } else {
                    const [year, month] = monthKey.split('-').map(Number);
                    monthSelect.innerHTML += `<option value="${monthKey}">${getMonthName(month)} ${year}</option>`;
                }
            });

            // Восстанавливаем сохраненное значение или используем текущее выбранное
            const savedValue = getSavedSelectedMonth();
            let valueToSelect = savedValue || currentSelectedValue;

            // Проверяем, существует ли выбранное значение в списке
            const optionExists = Array.from(monthSelect.options).some(option => option.value === valueToSelect);
            if (!optionExists) {
                // Если сохраненного значения нет в списке, выбираем "текущий месяц"
                valueToSelect = 'current';
            }

            monthSelect.value = valueToSelect;

            // Сохраняем выбранное значение в localStorage
            saveSelectedMonth(valueToSelect);
        }

        function getMonthName(monthNumber) {
            const monthNames = [
                'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ];
            return monthNames[monthNumber - 1] || '';
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function () {
            // Добавляем обработчик события change для сохранения выбранного месяца
            document.getElementById('monthSelect').addEventListener('change', function (e) {
                // Сохраняем выбранное значение
                saveSelectedMonth(e.target.value);
                // Загружаем статистику с новым выбранным месяцем
                loadCompletedStats();
            });

            // Инициализируем селектор месяцев пустыми данными
            updateMonthSelector([]);

            // Загружаем основные данные
            loadPublicData();

            // Закрытие тултипов при клике вне их
            document.addEventListener('click', function (event) {
                if (!event.target.closest('.files-count-wrapper')) {
                    document.querySelectorAll('.files-tooltip.show').forEach(tooltip => {
                        tooltip.classList.remove('show');
                    });
                }
            });
        });
    </script>
</body>

</html>